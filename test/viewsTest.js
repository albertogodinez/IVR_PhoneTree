var request = require('supertest');var cheerio = require('cheerio');var expect = require('chai').expect;var enableDestroy = require('server-destroy');describe('Views Tests', function () {    this.timeout(30000);    var server;    before(function () {        delete require.cache[require.resolve('../index')];        server = require('../index');        enableDestroy(server);    });    afterEach(function (done) {        server.destroy();        done();    });    it('/ should renders home', function (done) {        request(server)            .get('/')            .expect(200)            .end(done);    });    it('post to /ivr/welcome should serve TwiML with gather', function (done) {        request(server)            .post('/ivr/welcome')            .expect(200)            .end(function (err, response) {                var $ = cheerio.load(response.text);                expect($('Gather').children('Play').length).to.equal(1);                expect($('Gather').attr('action')).to.equal('/ivr/menu');                done();            });    });    it('post to /ivr/menu with 1 digit should serve TwiML with say twice and hangup', function (done) {        try {            request(server)                .post('/ivr/menu')                .type('form')                .send({Digits: '1'})                .expect(200)                .end(function (err, response) {                    var $ = cheerio.load(response.text);                    expect($('Say').length).to.equal(2);                    expect($('Hangup').length).to.equal(1);                    done();                });        }        catch (err) {        }    });    it('post to /ivr/menu with 2 digit should serve TwiML with gather and say', function (done) {        request(server)            .post('/ivr/menu')            .type('form')            .send({Digits: '2'})            .expect(200)            .end(function (err, response) {                var $ = cheerio.load(response.text);                expect($('Say').length).to.equal(1);                expect($('Gather').first().attr('action')).to.equal('/ivr/planets');                done();            });    });    it('post to /ivr/menu with digits other than 1 or 2 should redirect to welcome', function (done) {        request(server)            .post('/ivr/menu')            .type('form')            .send({Digits: '4'})            .expect(301)            .end(function (err, response) {                var $ = cheerio.load(response.text);                expect($('Redirect').length).to.equal(1);                expect($('Redirect').first().text()).to.equal('/ivr/welcome');                done();            });    });    it('post to /ivr/planets with digits 2, 3 or 4 should serve TwiML with dial', function (done) {        request(server)            .post('/ivr/planets')            .type('form')            .send({Digits: '4'})            .expect(200)            .end(function (err, response) {                var $ = cheerio.load(response.text);                expect($('Dial').first().text()).to.not.equal('');                done();            });    });    it('post to /ivr/planets with digits other than 2, 3 or 4 should redirect to welcome', function (done) {        request(server)            .post('/ivr/planets')            .type('form')            .send({Digits: '5'})            .expect(301)            .end(function (err, response) {                var $ = cheerio.load(response.text);                expect($('Redirect').length).to.equal(1);                expect($('Redirect').first().text()).to.equal('/ivr/welcome');                done();            });    });});